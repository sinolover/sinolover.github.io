# 调用规范stdcall和c语言的区别



**简介**

**\_\_cdecl **是C Declaration的缩写（declaration，声明），表示C语言默认的函数调用方法：所有参数从右到左依次入栈，这些参数由调用者清除，因此也被称为手动清栈。被调用函数不会要求调用者传递多少参数，调用者传递过多或者过少的参数，甚至完全不同的参数都不会产生编译阶段的错误。

**\_\_stdcall** 是StandardCall的缩写，是C++的标准调用方式：所有参数从右到左依次入栈，如果是调用类成员的话，最后一个入栈的是this指针。这些堆栈中的参数由被调用的函数在返回后清除，使用的指令是 retnX，X表示参数占用的字节数，CPU在ret之后自动弹出X个字节的堆栈空间。称为自动清栈。函数在编译的时候就必须确定参数个数，并且调用者必须严格的控制参数的生成，不能多，不能少，否则返回后会出错。

**PASCAL** 是Pascal语言的函数调用方式，也可以在C/C++中使用，参数压栈顺序与前两者相反。返回时的清栈方式与_stdcall相同。

**\_\_fastcall**是编译器指定的快速调用方式。由于大多数的函数参数个数很少，使用堆栈传递比较费时。因此\_fastcall通常规定将前两个（或若干个）参数由寄存器传递，其余参数还是通过堆栈传递。不同编译器编译的程序规定的寄存器不同。返回方式和\_stdcall相当。

**\_\_thiscall** 是为了解决类成员调用中this指针传递而规定的。\_\_thiscall要求把this指针放在特定寄存器中，该寄存器由编译器决定。VC使用ecx，Borland的C++编译器使用eax。返回方式和\_\_stdcall相当。

\_\_fastcall 和 \_\_thiscall涉及的寄存器由编译器决定，因此不能用作跨编译器的接口。所以Windows上的COM对象接口都定义为\_\_stdcall调用方式。

C中不加说明默认函数为\_\_cdecl方式（C中也只能用这种方式），C++也一样，但是默认的调用方式可以在IDE环境中设置。

带有可变参数的函数必须且只能使用_cdecl方式，例如下面的函数:
~~~ cpp
int printf(char * fmtStr, ...);

int scanf(char * fmtStr, ...);
~~~

**区别**

\_\_cdecl \_\_fastcall与\_\_stdcall，三者都是调用约定(Calling convention)，它决定以下内容：
1. 函数参数的压栈顺序
2. 由调用者还是被调用者把参数弹出栈，
3. 以及产生函数修饰名的方法。

1、__stdcall调用约定：函数的参数自右向左通过栈传递，被调用的函数在返回前清理传送参数的内存栈。

2、\_\_cdecl是C和C++程序的缺省调用方式。每一个调用它的函数都包含清空堆栈的代码，所以产生的可执行文件大小会比调用\_\_stdcall函数的大。函数采用从右到左的压栈方式。注意：对于可变参数的成员函数，始终使用__cdecl的转换方式。

3、__fastcall调用约定：它是通过寄存器来传送参数的（实际上，它用ECX和EDX传送前两个双字（DWORD）或更小的参数，剩下的参数仍旧自右向左压栈传送，被调用的函数在返回前清理传送参数的内存栈）。

4、thiscall仅仅应用于"C++"成员函数。this指针存放于CX寄存器，参数从右到左压。thiscall不是关键词，因此不能被程序员指定。

5、nakedcall采用1-4的调用约定时，如果必要的话，进入函数时编译器会产生代码来保存ESI，EDI，EBX，EBP寄存器，退出函数时则产生代码恢复这些寄存器的内容。nakedcall不产生这样的代码。naked call不是类型修饰符，故必须和\_\_declspec共同使用。
|标准|压参方向|清栈者|修饰名|备注|
|---|---|---|---|---|
|\_\_cdecl|右到左|调用者|\_函数名||
|\_\_stdcall|右到左 |函数 |\_函数名@参数总字节数 | |
|\_\_fastcall| 右到左 |函数 |@函数名@参数总字节数 | |
|PASCAL|左到右 |函数 | | |
|nakedcall| | | | |
||||||
||||||



**修饰名**
> 修饰名(Decoration name)："C"或者"C++"函数在内部（编译和链接）通过修饰名对函数重新命名

***C编译时函数名修饰约定规则：***
\_\_cdecl调用约定仅在输出函数名前加上一个下划线前缀，格式为\_functionname。
\_\_stdcall调用约定在输出函数名前加上一个下划线前缀，后面加上一个"@"符号和其参数的字节数，格式为\_functionname@number,例如 ：function(int a, int b)，其修饰名为：_function@8
\_\_fastcall调用约定在输出函数名前加上一个"@"符号，后面也是一个"@"符号和其参数的字节数，格式为@functionname@number。

***C++编译时函数名修饰约定规则：***

**设置方法**

1 可以直接在代码中写 __cdecl 等调用约定

2 在MS-VC++6.0中，调用约定也可以通过工程设置：Setting... 、、C/C++ \\Code Generation项进行选择，缺省状态为__cdecl。名字修饰约定(vs2010 在c/c++ 高